<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- 基本元数据设置 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据采集</title>
    <!-- 引入外部样式表 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- 左侧边栏 -->
        <div class="sidebar">
            <!-- 系统标题 -->
            <div class="logo">
                <h1>数据采集</h1>
            </div>
            <!-- 数据统计卡片区域 -->
            <div class="data-stats">
                <!-- 学术论文统计卡片 -->
                <div class="stat-card">
                    <div class="stat-icon academic-icon">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="academic-count">117</div>
                        <div class="stat-label">学术论文</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon report-icon">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M4 19.5v-15A2.5 2.5 0 016.5 2h11A2.5 2.5 0 0120 4.5v15a2.5 2.5 0 01-2.5 2.5h-11A2.5 2.5 0 014 19.5z" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 7h8M8 11h8M8 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="report-count">117</div>
                        <div class="stat-label">调查报告</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon book-icon">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M4 19.5v-15A2.5 2.5 0 016.5 2h11A2.5 2.5 0 0120 4.5v15a2.5 2.5 0 01-2.5 2.5h-11A2.5 2.5 0 014 19.5z" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 6v12M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="book-count">117</div>
                        <div class="stat-label">专业书籍</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon policy-icon">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" stroke-width="2"/>
                            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="policy-count">117</div>
                        <div class="stat-label">政策文件</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon standard-icon">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="standard-count">117</div>
                        <div class="stat-label">法规标准</div>
                    </div>
                </div>
            </div>
            <!-- 控制面板区域 -->
            <div class="control-panel">
                <div class="panel-header">数据源选择</div>
                <!-- 数据源选择按钮组 -->
                <div class="data-source">
                    <button class="source-option" onclick="selectSource('academic')">
                        <div class="source-icon academic-icon">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="source-name">学术论文</span>
                    </button>
                    <button class="source-option" onclick="selectSource('report')">
                        <div class="source-icon report-icon">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M4 19.5v-15A2.5 2.5 0 016.5 2h11A2.5 2.5 0 0120 4.5v15a2.5 2.5 0 01-2.5 2.5h-11A2.5 2.5 0 014 19.5z" stroke="currentColor" stroke-width="2"/>
                                <path d="M8 7h8M8 11h8M8 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <span class="source-name">调查报告</span>
                    </button>
                    <button class="source-option" onclick="selectSource('book')">
                        <div class="source-icon book-icon">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M4 19.5v-15A2.5 2.5 0 016.5 2h11A2.5 2.5 0 0120 4.5v15a2.5 2.5 0 01-2.5 2.5h-11A2.5 2.5 0 014 19.5z" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 6v12M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <span class="source-name">专业书籍</span>
                    </button>
                    <button class="source-option" onclick="selectSource('policy')">
                        <div class="source-icon policy-icon">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" stroke-width="2"/>
                                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="source-name">政策文件</span>
                    </button>
                    <button class="source-option" onclick="selectSource('standard')">
                        <div class="source-icon standard-icon">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="source-name">法规标准</span>
                    </button>
                </div>
                <!-- 爬取控制按钮组 -->
                <div class="control-buttons">
                    <button class="start-button" onclick="startCrawling()">
                        <span class="button-icon"></span>
                        开始爬取
                    </button>
                    <button class="stop-button" onclick="stopCrawling()">
                        <span class="button-icon"></span>
                        停止爬取
                    </button>
                </div>
            </div>
        </div>
        <!-- 主要内容区域 -->
        <div class="main-content">
            <!-- 顶部统计区域 -->
            <div class="top-stats">
                <!-- 实时数据统计面板 -->
                <div class="stat-panel">
                    <div class="panel-title">实时数据统计</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-header">爬取速度</div>
                            <div class="stat-body">
                                <span class="stat-value" id="speed">0</span>
                                <span class="stat-unit">条/秒</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-header">总数据量</div>
                            <div class="stat-body">
                                <span class="stat-value" id="total">0</span>
                                <span class="stat-unit">条</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 趋势图表面板 -->
                <div class="chart-panel">
                    <div class="panel-title">24小时爬取趋势</div>
                    <div class="trend-chart" id="trend-chart"></div>
                </div>
            </div>
            <!-- 实时结果显示区域 -->
            <div class="results-panel">
                <div class="panel-title">实时爬取结果</div>
                <div class="results-container" id="results"></div>
            </div>
        </div>
    </div>

    <!-- 引入ECharts图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        // 全局变量定义
        let selectedSource = null;  // 当前选中的数据源
        let isCrawling = false;    // 爬取状态标志
        let currentRequest = null;  // 当前请求对象
        let totalCount = 0;        // 总数据量计数
        let speedCounter = 0;      // 速度计数器
        let speedTimer = null;     // 速度更新定时器
        let trendChart = null;     // 趋势图表实例
        let trendData = Array(24).fill(0);  // 24小时趋势数据
        let currentHour = new Date().getHours();  // 当前小时数

        /**
         * 更新统计数据和图表
         */
        function updateStats() {
            // 更新总数和速度显示
            document.getElementById('total').textContent = totalCount;
            document.getElementById('speed').textContent = speedCounter;

            // 更新趋势图表数据
            updateTrendChart(speedCounter);
            
            // 重置速度计数器
            speedCounter = 0;

            // 更新左侧各类型数据统计
            const counts = {
                'academic': totalCount,
                'report': totalCount,
                'book': totalCount,
                'policy': totalCount,
                'standard': totalCount
            };

            // 更新所有数据类型的计数显示
            Object.keys(counts).forEach(type => {
                const countElement = document.getElementById(`${type}-count`);
                if (countElement) {
                    countElement.textContent = counts[type];
                }
            });
        }

        /**
         * 初始化趋势图表
         */
        function initTrendChart() {
            // 获取图表容器DOM元素
            const chartDom = document.getElementById('trend-chart');
            trendChart = echarts.init(chartDom);

            // 配置图表选项
            const option = {
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: Array.from({length: 24}, (_, i) => `${i}:00`)
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: trendData,
                    type: 'line',
                    smooth: true,
                    areaStyle: {}
                }]
            };

            // 应用图表配置
            trendChart.setOption(option);
        }

        /**
         * 更新趋势图表数据
         * @param {number} value - 当前小时的数据值
         */
        function updateTrendChart(value) {
            // 更新当前小时的数据
            const hour = new Date().getHours();
            if (hour !== currentHour) {
                trendData = [...trendData.slice(1), 0];
                currentHour = hour;
            }
            trendData[23] += value;

            // 更新图表显示
            trendChart.setOption({
                series: [{
                    data: trendData
                }]
            });
        }

        /**
         * 选择数据源
         * @param {string} source - 数据源类型
         */
        function selectSource(source) {
            // 移除之前选中的数据源样式
            if (selectedSource) {
                document.querySelector(`.source-option[onclick*="${selectedSource}"]`)
                    .classList.remove('selected');
            }

            // 更新选中的数据源
            selectedSource = source;
            document.querySelector(`.source-option[onclick*="${source}"]`)
                .classList.add('selected');
        }

        /**
         * 开始数据爬取
         */
        function startCrawling() {
            if (!selectedSource) {
                alert('请先选择数据源！');
                return;
            }

            // 更新UI状态
            isCrawling = true;
            document.querySelector('.start-button').classList.add('disabled');
            document.querySelector('.stop-button').classList.remove('disabled');

            // 启动速度统计定时器
            speedTimer = setInterval(updateStats, 1000);

            // 开始爬取数据
            fetchData();
        }

        /**
         * 停止数据爬取
         */
        function stopCrawling() {
            // 更新UI状态
            isCrawling = false;
            document.querySelector('.start-button').classList.remove('disabled');
            document.querySelector('.stop-button').classList.add('disabled');

            // 清除定时器和当前请求
            clearInterval(speedTimer);
            if (currentRequest) {
                currentRequest.abort();
            }
        }

        /**
         * 获取爬取数据
         */
        function fetchData() {
            if (!isCrawling) return;

            // 创建新的请求
            currentRequest = new XMLHttpRequest();
            currentRequest.open('GET', `/crawl/${selectedSource}`, true);

            currentRequest.onload = function() {
                if (this.status === 200) {
                    const data = JSON.parse(this.responseText);
                    
                    // 更新计数器
                    totalCount++;
                    speedCounter++;

                    // 添加结果到显示区域
                    addResult(data);

                    // 延迟获取下一批数据
                    setTimeout(fetchData, 1000);
                }
            };

            currentRequest.onerror = function() {
                console.error('请求失败');
                stopCrawling();
            };

            currentRequest.send();
        }

        /**
         * 添加结果到显示区域
         * @param {Object} data - 爬取的数据
         */
        function addResult(data) {
            const resultsContainer = document.getElementById('results');
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.style.animation = 'slideIn 0.5s ease-out';
            
            // 构建结果HTML
            resultItem.innerHTML = `
                <div class="result-title">${data.title}</div>
                <div class="result-meta">
                    <span class="source">${data.source}</span>
                    <span class="time">${new Date().toLocaleTimeString()}</span>
                </div>
            `;

            // 添加到容器并限制显示数量
            resultsContainer.insertBefore(resultItem, resultsContainer.firstChild);
            if (resultsContainer.children.length > 50) {
                resultsContainer.removeChild(resultsContainer.lastChild);
            }
        }

        // 页面加载完成后初始化图表
        window.onload = function() {
            initTrendChart();
        };
    </script>
</body>
</html> 